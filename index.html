<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Вклад патологии почек в рСКФ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  
    body { 
        font-family: Arial, sans-serif; 
        background: #f9f9f9; 
        margin: 0; 
       
        padding: 20px env(safe-area-inset-right) 20px env(safe-area-inset-left); 
        color: #222; 
    }
    .container { 
        max-width: 900px; 
        margin: auto; 
        background: white; 
        padding: 30px; 
        border-radius: 12px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        
        box-sizing: border-box; 
    }
    h1 { text-align: center; color: #0d47a1; margin-bottom: 15px; font-size: 1.7em; }
    label { display: block; margin: 16px 0 5px; font-weight: bold; color: #0d47a1; }
    
  
    input, select { 
        width: 100%; 
        padding: 11px; 
        border: 1px solid #aaa; 
        border-radius: 6px; 
        font-size: 16px; 
        box-sizing: border-box; 
    }
    button { width: 100%; padding: 14px; background: #0d47a1; color: white; border: none; border-radius: 6px; font-size: 1.15em; cursor: pointer; margin-top: 20px; }
    button:hover { background: #003366; }
    #result { margin-top: 35px; display: none; padding: 20px; background: #ffffff; border-radius: 8px; }
    .value { font-weight: normal; font-size: 1.1em; }
    
    #riskIndicator { margin-top: 15px; padding: 15px; border-radius: 6px; border-left: 5px solid; font-style: italic; }
    .risk-low { background: #e8f5e9; border-color: #2e7d32; color: #1b5e20; }
    .risk-medium { background: #fff3e0; border-color: #f57c00; color: #e65100; }
    .risk-high { background: #ffebee; border-color: #d32f2f; color: #b71c1c; }

    canvas { max-height: 480px; margin-top: 25px; width: 100% !important; }
    .note { font-size: 0.9em; color: #555; margin-top: 15px; text-align: center; }
    .points-container { margin-top: 20px; }
    
    /* АДАПТАЦИЯ СТРОК: замена фиксированного gap на адаптивный flex */
    .point-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .point-row input { width: 45%; }
    .add-btn { width: auto; padding: 10px 15px; background: #0d47a1; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 1em; }
    .remove-btn { background: #e0e0e0; color: #333; border: none; padding: 10px 12px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
    .clear-btn { background: #757575; margin-top: 15px; font-size: 1em; }
    .result-text { font-size: 1.1em; margin: 12px 0; line-height: 1.4; }
    .ckd-badge { font-weight: bold; color: #0d47a1; margin-left: 8px; background: #e3f2fd; padding: 4px 10px; border-radius: 6px; border: 1px solid #0d47a1; display: inline-block; vertical-align: middle; }

    @media (max-width: 480px) {
        .container { padding: 15px; border-radius: 0; }
        .flex-container { flex-direction: column; gap: 0 !important; }
        .point-row { flex-wrap: wrap; }
        .point-row input { width: 40%; }
        h1 { font-size: 1.4em; }
    }
    
    .flex-container { display: flex; gap: 15px; }
    .flex-item { flex: 1; }
  </style>
</head>
<body>

<div class="container">
  <h1>Калькулятор вклада патологии почек в рСКФ</h1>

  <form id="form">
    <div class="flex-container">
        <div class="flex-item">
            <label>Пол</label>
            <select id="gender" required>
              <option value="" disabled selected>— выберите —</option>
              <option value="female">Женщина</option>
              <option value="male">Мужчина</option>
            </select>
        </div>
        <div class="flex-item">
            <label>Раса</label>
            <select id="race" required>
              <option value="other">Другие</option>
              <option value="black">Негроидная</option>
            </select>
        </div>
    </div>

    <div class="flex-container">
        <div class="flex-item">
            <label>Текущий возраст, лет</label>
            <input type="number" id="age" min="18" max="100" required>
        </div>
        <div class="flex-item">
            <label>Возраст начала лечения</label>
            <input type="number" id="treat_age" min="18" max="100">
        </div>
    </div>

    <label>Текущий креатинин, мкмоль/л</label>
    <input type="number" id="creat" min="30" max="800" step="0.1" required>

    <div class="points-container" id="points">
      <h3 style="margin-top: 20px;">Дополнительные точки (возраст + креатинин)</h3>
      <button type="button" class="add-btn" id="addPoint">+ Добавить точку</button>
    </div>

    <button type="submit" style="margin-top: 30px;">Рассчитать</button>
    <button type="button" class="clear-btn" id="clearAll" onclick="location.reload()">Очистить</button>
  </form>

  <div id="result">
    <div class="result-text">
      <p>Реальная рСКФ (C): <span class="value" id="real" style="color: #b71c1c;"></span> мл/мин/1,73 м² <span id="ckdStage" class="ckd-badge"></span></p>
      <p>Прогнозируемая рСКФ (B): <span class="value" id="pred" style="color: #b71c1c;"></span> мл/мин/1,73 м²</p>
      <p><strong>Вклад патологии почек (ВПП):</strong> <span class="value" id="vpp" style="font-weight: bold; color: #b71c1c;"></span> %</p>
    </div>

    <div id="riskIndicator">
      <span id="riskText"></span>
    </div>

    <canvas id="chart"></canvas>

    <div class="note">
      B — прогнозируемая СКФ при креатинине 80 мкмоль/л (женщины) или 100 мкмоль/л (мужчины)
    </div>
  </div>
</div>

<script>

function getYearWord(n) {
  let m = Math.abs(n) % 100;
  let m1 = m % 10;
  if (m > 10 && m < 20) return 'лет';
  if (m1 > 1 && m1 < 5) return 'года';
  if (m1 === 1) return 'год';
  return 'лет';
}

function getCKDStage(egfr) {
  if (egfr >= 90) return "ХБП стадия C1";
  if (egfr >= 60) return "ХБП стадия C2";
  if (egfr >= 45) return "ХБП стадия C3а";
  if (egfr >= 30) return "ХБП стадия C3б";
  if (egfr >= 15) return "ХБП стадия C4";
  return "ХБП стадия C5";
}

function ckdepi2011(scr_mgdl, age, female, race) {
  const kappa = female ? 0.7 : 0.9;
  const alpha = female ? -0.329 : -0.411;
  const minv = Math.min(scr_mgdl / kappa, 1);
  const maxv = Math.max(scr_mgdl / kappa, 1);
  let egfr = 141 * Math.pow(minv, alpha) * Math.pow(maxv, -1.209) * Math.pow(0.993, age);
  if (female) egfr *= 1.018;
  if (race === 'black') egfr *= 1.159;
  return Math.max(0, Math.round(egfr * 10) / 10);
}

document.getElementById('addPoint').addEventListener('click', () => {
  const container = document.getElementById('points');
  const btn = document.getElementById('addPoint');
  const row = document.createElement('div');
  row.className = 'point-row';
  row.innerHTML = `<input type="number" class="point-age" min="18" max="100" placeholder="Возраст" required>
                   <input type="number" class="point-creat" min="30" max="800" step="0.1" placeholder="Креат." required>
                   <button type="button" class="remove-btn">Удалить</button>`;
  container.insertBefore(row, btn);
  row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
});

document.getElementById('form').addEventListener('submit', e => {
  e.preventDefault();
  const gender = document.getElementById('gender').value;
  const race = document.getElementById('race').value;
  const ageNow = parseInt(document.getElementById('age').value);
  const treatAge = parseInt(document.getElementById('treat_age').value);
  const poolCreat = parseFloat(document.getElementById('creat').value);
  const female = gender === 'female';
  const fixed_umol = female ? 80 : 100;

  const real_egfr = ckdepi2011(poolCreat / 88.4, ageNow, female, race);
  const pred_egfr = ckdepi2011(fixed_umol / 88.4, ageNow, female, race);
  const vpp = pred_egfr > 0 ? Math.round((pred_egfr - real_egfr) * 100 / pred_egfr) : 0;

  document.getElementById('real').textContent = real_egfr;
  document.getElementById('pred').textContent = pred_egfr;
  document.getElementById('vpp').textContent = vpp;
  document.getElementById('ckdStage').textContent = getCKDStage(real_egfr);

  const riskBox = document.getElementById('riskIndicator');
  const riskText = document.getElementById('riskText');
  riskBox.className = ''; riskBox.style.display = 'block';
  if (vpp < 17.9) { riskBox.classList.add('risk-low'); riskText.innerHTML = "<b>Вклад патологии почек:</b> ВПП < 17,9%."; }
  else if (vpp <= 43.3) { riskBox.classList.add('risk-medium'); riskText.innerHTML = "<b>Вклад патологии почек:</b> ВПП 17,9 - 43,3%."; }
  else { riskBox.classList.add('risk-high'); riskText.innerHTML = "<b>Вклад патологии почек!</b> ВПП > 43,3%."; }

  let patientPoints = [];
  let agesUsed = [ageNow];
  if (treatAge) agesUsed.push(treatAge);

  document.querySelectorAll('.point-row').forEach(row => {
    const age = parseInt(row.querySelector('.point-age').value);
    const cr = parseFloat(row.querySelector('.point-creat').value);
    if (age && cr) {
      patientPoints.push({ x: age, y: ckdepi2011(cr / 88.4, age, female, race) });
      agesUsed.push(age);
    }
  });
  patientPoints.push({ x: ageNow, y: real_egfr });
  patientPoints.sort((a, b) => a.x - b.x);

  const minBound = Math.max(0, Math.min(...agesUsed) - 5);
  const maxBound = Math.min(100, Math.max(...agesUsed) + 5);

  const agesForNorm = [];
  for (let a = minBound; a <= maxBound; a += 1) {
    agesForNorm.push({ x: a, y: ckdepi2011(fixed_umol / 88.4, a, female, race) });
  }

  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();

  window.myChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'Возрастная норма (B)', data: agesForNorm, backgroundColor: '#1976d2', pointRadius: 5, type: 'line', borderColor: '#1976d2', borderWidth: 3, tension: 0.2, showLine: true },
        { label: 'Реальные точки пациента', data: patientPoints, backgroundColor: '#d32f2f', pointRadius: 8, type: 'line', borderColor: '#d32f2f', borderWidth: 2, tension: 0.1, showLine: true }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Возраст, лет' }, min: minBound, max: maxBound },
        y: { title: { display: true, text: 'рСКФ, мл/мин/1,73 м²' }, min: 0, max: 130 }
      }
    }
  });

  const chart = window.myChart;
  const origDraw = chart.draw;
  chart.draw = function() {
    origDraw.apply(this, arguments);
    const xAxis = chart.scales.x; const yAxis = chart.scales.y; const c = chart.ctx;
    if (treatAge) {
      const xPos = xAxis.getPixelForValue(treatAge);
      c.save(); c.beginPath(); c.setLineDash([5, 5]); c.moveTo(xPos, yAxis.top); c.lineTo(xPos, yAxis.bottom);
      c.lineWidth = 2; c.strokeStyle = '#2e7d32'; c.stroke();
      c.setLineDash([]); c.fillStyle = '#2e7d32'; c.font = 'bold 12px Arial'; c.fillText('Начало терапии', xPos + 8, yAxis.top + 15);
      c.restore();
    }
  };
  chart.update();
  document.getElementById('result').style.display = 'block';
});
</script>
</body>
</html>
